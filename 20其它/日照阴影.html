<!DOCTYPE html>
<html lang="cn">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>日照分析</title>
    <style>
      @import url(../Source/Widgets/widgets.css);

      html,
      body,
      #cesiumContainer {
        width: 100%;
        height: 100%;
        margin: 0;
        padding: 0;
        overflow: hidden;
      }

      #menu {
        position: absolute;
        top: 80px;
        left: 10px;
        z-index: 999;
      }
    </style>
  </head>

  <body>
    <div id="cesiumContainer"></div>
    <div id="menu">
      <p>
        <button onclick="setvisible('play')">播放</button>
      </p>
      <p>
        <button onclick="setvisible('stop')">暂停</button>
      </p>
    </div>
    <script type="module">
      window.CESIUM_BASE_URL = "../Source/";
      import * as Cesium from "../Source/Cesium.js";
      Cesium.Ion.defaultAccessToken =
        "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJqdGkiOiJkZDBlZWVlNi0wODY2LTQ5ZTctODI4MS0wZjQ4NWU5OGVhODUiLCJpZCI6NjA3Niwic2NvcGVzIjpbImFzbCIsImFzciIsImFzdyIsImdjIl0sImlhdCI6MTU2MzE2MzkxOX0.aE3JBR8xqVtCDSbPl7uQLk57mae8ICqIlfwWfjuv8js";

      // var date = new Date("2019/10/04 12:30:00"); //时间为：2019/10/04 12:00:00

      // var julianTime = Cesium.JulianDate.fromDate(date); //转为JulianDate
      // console.log(julianTime);

      let osm = new Cesium.OpenStreetMapImageryProvider({
        url: "https://a.tile.openstreetmap.org/"
      });

      let viewer = new Cesium.Viewer("cesiumContainer", {
        imageryProvider: osm,
        contextOptions: {
          webgl: {
            alpha: true
          }
        },
        selectionIndicator: false,
        animation: false, //是否显示动画控件
        baseLayerPicker: false, //是否显示图层选择控件
        geocoder: false, //是否显示地名查找控件
        timeline: false, //是否显示时间线控件
        sceneModePicker: false, //是否显示投影方式控件
        navigationHelpButton: false, //是否显示帮助信息控件
        infoBox: false, //是否显示点击要素之后显示的信息
        fullscreenButton: false
      });

      //https://blog.csdn.net/qq_32685139/article/details/97926437
      viewer.scene.globe.enableLighting = true;
      viewer.shadows = true;

      console.log(viewer.scene.context.uniformState.sunPositionWC);

      var tileset = new Cesium.Cesium3DTileset({
        url: "../8model_op_bim/data/Tilesets/Tileset/tileset.json"
      });
      viewer.scene.primitives.add(tileset);
      tileset.readyPromise.then(function() {
        viewer.zoomTo(
          tileset,
          new Cesium.HeadingPitchRange(
            0.0,
            -0.5,
            tileset.boundingSphere.radius / 4.0
          )
        );
      });
      var stopTime = null;
      window.stratPlay = function stratPlay() {
        if (((viewer.clock.shouldAnimate = true), stopTime))
          viewer.clock.currentTime = stopTime;
        else {
          var e = "2022-01-01",
            t = new Date(e),
            startHours = "00",
            endHours = "24",
            start = new Date(new Date(t).setHours(Number(startHours))),
            end = new Date(new Date(t).setHours(Number(endHours)));
          viewer.scene.globe.enableLighting = true;
          viewer.shadows = true;
          viewer.clock.startTime = Cesium.JulianDate.fromDate(start);
          viewer.clock.currentTime = Cesium.JulianDate.fromDate(start);
          viewer.clock.stopTime = Cesium.JulianDate.fromDate(end);
          viewer.clock.clockRange = Cesium.ClockRange.LOOP_STOP;
          viewer.clock.clockStep = Cesium.ClockStep.SYSTEM_CLOCK_MULTIPLIER;
          viewer.clock.multiplier = 1600;
          console.log(viewer.scene.context.uniformState.sunPositionWC);
          checkSunSet();
        }
      };
      window.stopPlay = function stopPlay() {
        (stopTime = viewer.clock.currentTime),
          (viewer.clock.shouldAnimate = false);
        console.log(viewer.scene.context.uniformState.sunPositionWC);
      };

      window.setvisible = function setvisible(value) {
        switch (value) {
          case "play":
            stratPlay();
            break;
          case "stop":
            stopPlay();
            break;
        }
      };

      viewer.clock.onTick.addEventListener(function() {
        //console.log(viewer.scene.context.uniformState.sunPositionWC);
      });

      // https://github.com/mourner/suncalc
      // https://community.cesium.com/t/turn-off-skyatmosphere-after-sunset/3311/2
      window.checkSunSet = function() {
        var transformMatrix = new Cesium.Matrix4();

        var toSun = new Cesium.Cartesian3();

        var toMoon = new Cesium.Cartesian3();

        viewer.clock.onTick.addEventListener(function(clock) {
          //var position = viewer.scene.camera.position;

          //  此点为3dtiles 范围的一点
          var position = Cesium.Cartesian3.fromDegrees(
            -75.61256974524136,
            40.042031724941786,
            0,
            Cesium.Ellipsoid.WGS84,
            new Cesium.Cartesian3()
          );

          var up = viewer.scene.globe.ellipsoid.geodeticSurfaceNormal(position);

          var time = clock.currentTime;

          Cesium.Transforms.computeTemeToPseudoFixedMatrix(
            time,
            transformMatrix
          );

          Cesium.Simon1994PlanetaryPositions.computeSunPositionInEarthInertialFrame(
            time,
            toSun
          );

          Cesium.Matrix3.multiplyByVector(transformMatrix, toSun, toSun);

          Cesium.Cartesian3.normalize(toSun, toSun);

          viewer.scene.skyAtmosphere.show =
            Cesium.Cartesian3.dot(up, toSun) > 0.0;
          console.log(viewer.scene.skyAtmosphere.show);
        });
      };
    </script>
  </body>
</html>
