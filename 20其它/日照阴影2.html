<!DOCTYPE html>
<html lang="cn">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>日照分析</title>
    <style>
      @import url(../Source/Widgets/widgets.css);

      html,
      body,
      #cesiumContainer {
        width: 100%;
        height: 100%;
        margin: 0;
        padding: 0;
        overflow: hidden;
      }

      #menu {
        position: absolute;
        top: 80px;
        left: 10px;
        z-index: 999;
      }
    </style>
  </head>

  <body>
    <div id="cesiumContainer"></div>
    <div style="display:none;" id="tooltip"></div>
    <div id="menu">
      <p>
        <button onclick="draw()">绘制面</button>
        <button onclick="addRectangle()">添加矩形</button>
        <button onclick="clearAll()">清除面</button>
      </p>
      <p>
        <button onclick="setvisible('play')">播放</button>
      </p>
      <p>
        <button onclick="setvisible('stop')">暂停</button>
      </p>
    </div>
    <script type="module">
      window.CESIUM_BASE_URL = "../Source/";
      import * as Cesium from "../Source/Cesium.js";
      Cesium.Ion.defaultAccessToken =
        "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJqdGkiOiJkZDBlZWVlNi0wODY2LTQ5ZTctODI4MS0wZjQ4NWU5OGVhODUiLCJpZCI6NjA3Niwic2NvcGVzIjpbImFzbCIsImFzciIsImFzdyIsImdjIl0sImlhdCI6MTU2MzE2MzkxOX0.aE3JBR8xqVtCDSbPl7uQLk57mae8ICqIlfwWfjuv8js";

      // var date = new Date("2019/10/04 12:30:00"); //时间为：2019/10/04 12:00:00

      // var julianTime = Cesium.JulianDate.fromDate(date); //转为JulianDate
      // console.log(julianTime);

      let osm = new Cesium.OpenStreetMapImageryProvider({
        url: "https://a.tile.openstreetmap.org/"
      });

      let viewer = new Cesium.Viewer("cesiumContainer", {
        imageryProvider: osm,
        contextOptions: {
          webgl: {
            alpha: true
          }
        },
        selectionIndicator: false,
        animation: false, //是否显示动画控件
        baseLayerPicker: false, //是否显示图层选择控件
        geocoder: false, //是否显示地名查找控件
        timeline: false, //是否显示时间线控件
        sceneModePicker: false, //是否显示投影方式控件
        navigationHelpButton: false, //是否显示帮助信息控件
        infoBox: false, //是否显示点击要素之后显示的信息
        fullscreenButton: false
      });

      //https://blog.csdn.net/qq_32685139/article/details/97926437
      viewer.scene.globe.enableLighting = true;
      viewer.shadows = true;

      console.log(viewer.scene.context.uniformState.sunPositionWC);

      var tileset = new Cesium.Cesium3DTileset({
        url: "../8model_op_bim/data/Tilesets/Tileset/tileset.json"
      });
      viewer.scene.primitives.add(tileset);
      tileset.readyPromise.then(function() {
        viewer.zoomTo(
          tileset,
          new Cesium.HeadingPitchRange(
            0.0,
            -0.5,
            tileset.boundingSphere.radius / 4.0
          )
        );
      });
      var stopTime = null;
      window.stratPlay = function stratPlay() {
        if (((viewer.clock.shouldAnimate = true), stopTime))
          viewer.clock.currentTime = stopTime;
        else {
          var e = "2022-01-01",
            t = new Date(e),
            startHours = "00",
            endHours = "24",
            start = new Date(new Date(t).setHours(Number(startHours))),
            end = new Date(new Date(t).setHours(Number(endHours)));
          viewer.scene.globe.enableLighting = true;
          viewer.shadows = true;
          viewer.clock.startTime = Cesium.JulianDate.fromDate(start);
          viewer.clock.currentTime = Cesium.JulianDate.fromDate(start);
          viewer.clock.stopTime = Cesium.JulianDate.fromDate(end);
          viewer.clock.clockRange = Cesium.ClockRange.LOOP_STOP;
          viewer.clock.clockStep = Cesium.ClockStep.SYSTEM_CLOCK_MULTIPLIER;
          viewer.clock.multiplier = 1600;
          console.log(viewer.scene.context.uniformState.sunPositionWC);
        }
      };
      window.stopPlay = function stopPlay() {
        (stopTime = viewer.clock.currentTime),
          (viewer.clock.shouldAnimate = false);
        console.log(viewer.scene.context.uniformState.sunPositionWC);
      };

      window.setvisible = function setvisible(value) {
        switch (value) {
          case "play":
            stratPlay();
            break;
          case "stop":
            stopPlay();
            break;
        }
      };

      // viewer.clock.onTick.addEventListener(function() {
      //   console.log(viewer.scene.context.uniformState.sunPositionWC);
      // });

      /////////////////////////////////////// 绘制逻辑
      var tempEntities = [];

      window.draw = function draw() {
        var position;
        var tempPoints = [];
        var handler = new Cesium.ScreenSpaceEventHandler(viewer.scene.canvas);
        var tooltip = document.getElementById("tooltip");
        tooltip.style.display = "block";
        //鼠标移动事件
        handler.setInputAction(function(movement) {
          tooltip.style.left = movement.endPosition.x + 10 + "px";
          tooltip.style.top = movement.endPosition.y + 20 + "px";
        }, Cesium.ScreenSpaceEventType.MOUSE_MOVE);
        //左键点击操作
        handler.setInputAction(function(click) {
          //调用获取位置信息的接口
          position = viewer.camera.pickEllipsoid(
            click.position,
            viewer.scene.globe.ellipsoid
          );
          tempPoints.push(position);
          let tempLength = tempPoints.length;
          //调用绘制点的接口
          let point = drawPoint(position);
          tempEntities.push(point);
          if (tempLength > 1) {
            let pointline = drawPolyline([
              tempPoints[tempPoints.length - 2],
              tempPoints[tempPoints.length - 1]
            ]);
            tempEntities.push(pointline);
          } else {
            tooltip.innerHTML = "请绘制下一个点，右键结束";
          }
          return;
        }, Cesium.ScreenSpaceEventType.LEFT_CLICK);
        //右键点击操作
        handler.setInputAction(function(click) {
          let cartesian = viewer.camera.pickEllipsoid(
            click.position,
            viewer.scene.globe.ellipsoid
          );
          if (cartesian) {
            let tempLength = tempPoints.length;
            if (tempLength < 3) {
              alert("请选择3个以上的点再执行闭合操作命令");
            } else {
              //闭合最后一条线
              let pointline = drawPolyline([
                tempPoints[tempPoints.length - 1],
                tempPoints[0]
              ]);
              tempEntities.push(pointline);
              var polygontemp = drawPolygon(tempPoints);
              tempEntities.push(polygontemp);
              tempEntities.push(tempPoints);
              handler.destroy(); //关闭事件句柄
              handler = null;
            }
          }
        }, Cesium.ScreenSpaceEventType.RIGHT_CLICK);
      };

      window.drawPoint = function drawPoint(position, config) {
        var config = config ? config : {};
        var pointGeometry = viewer.entities.add({
          name: "点几何对象",
          position: position,
          point: {
            color: Cesium.Color.SKYBLUE,
            pixelSize: 10,
            outlineColor: Cesium.Color.YELLOW,
            outlineWidth: 3,
            disableDepthTestDistance: Number.POSITIVE_INFINITY
          }
        });
        return pointGeometry;
      };

      window.drawPolyline = function drawPolyline(positions, config) {
        if (positions.length < 1) return;
        var config = config ? config : {};
        var polylineGeometry = viewer.entities.add({
          name: "线几何对象",
          polyline: {
            positions: positions,
            width: config.width ? config.width : 5.0,
            material: new Cesium.PolylineGlowMaterialProperty({
              color: config.color
                ? new Cesium.Color.fromCssColorString(config.color)
                : Cesium.Color.GOLD
            }),
            depthFailMaterial: new Cesium.PolylineGlowMaterialProperty({
              color: config.color
                ? new Cesium.Color.fromCssColorString(config.color)
                : Cesium.Color.GOLD
            })
          }
        });
        return polylineGeometry;
      };

      window.drawPolygon = function drawPolygon(positions, config) {
        if (positions.length < 2) return;
        var config = config ? config : {};
        var polygonGeometry = viewer.entities.add({
          name: "线几何对象",
          polygon: {
            height: 0.1,
            hierarchy: new Cesium.PolygonHierarchy(positions),
            material: config.color
              ? new Cesium.Color.fromCssColorString(config.color).withAlpha(0.2)
              : new Cesium.Color.fromCssColorString("#FFD700").withAlpha(0.2),
            perPositionHeight: true
          }
        });
        return polygonGeometry;
      };

      window.clearAll = function() {
        tempEntities.forEach(item => {
          viewer.entities.remove(item);
        });
      };

      var redRectangle;
      window.addRectangle = function() {
        var p1 = {
          lng: -75.61256974524136,
          lat: 40.043181650145875,
          height: 0
        };

        var p1 = {
          lng: -75.61174849848568,
          lat: 40.042031724941786,
          height: 0
        };

        redRectangle = viewer.entities.add({
          name: "Red translucent rectangle",
          rectangle: {
            coordinates: Cesium.Rectangle.fromDegrees(
              -75.61256974524136,
              40.042031724941786,

              -75.61174849848568,
              40.043181650145875
            ),
            material: Cesium.Color.RED.withAlpha(0.7),
            classificationType: Cesium.ClassificationType.TERRAIN
          }
        });

        tempEntities.push(redRectangle);
      };

      /////////////////////////////////////// 绘制逻辑结束

      window.generateCalculatePoints = function(count) {};
    </script>
  </body>
</html>
